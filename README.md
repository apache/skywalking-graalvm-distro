# SkyWalking GraalVM Distro (Experimental)
<img src="http://skywalking.apache.org/assets/logo.svg" alt="Sky Walking logo" height="90px" align="right" />

GraalVM compiles your Java applications ahead of time into standalone binaries. These binaries are smaller, start up to 100x faster, provide peak performance with no warmup, and use less memory and CPU than applications running on a Java Virtual Machine (JVM).

SkyWalking GraalVM Distro is a re-distribution version of the official Apache SkyWalking OAP server, targeting GraalVM native image on JDK 25.

## Why This Is Hard

SkyWalking OAP server relies heavily on runtime code generation and dynamic class loading — patterns that are fundamentally incompatible with GraalVM native image's closed-world assumption:

| Runtime Pattern | Where Used | Scale |
|---|---|---|
| **Javassist bytecode generation** | OAL metrics classes, MAL meter classes | ~1,850 classes generated at startup |
| **Groovy dynamic compilation** | MAL meter expressions, LAL log rules | ~1,260 scripts compiled at startup |
| **Guava ClassPath scanning** | Annotation discovery, function registry | 7 scanning sites |
| **ServiceLoader (SPI)** | Module/provider discovery | All modules |
| **Reflection-based config** | `Field.setAccessible()` for YAML config | All `ModuleConfig` subclasses |

None of these work in a GraalVM native image out of the box.

## Strategy: Build-Time Pre-Compilation

The core idea is simple: **move all dynamic code generation and classpath scanning from runtime to build time**. At build time, run the full OAL/MAL/LAL initialization pipeline, capture all generated bytecode, and package it into the native image classpath. At runtime, load pre-compiled classes from manifests — no Javassist, no GroovyShell, no ClassPath scanning.

```
┌─────────────────────────────────────────────────────────┐
│                    BUILD TIME                            │
│                                                         │
│  skywalking/         build-tools/precompiler             │
│  (submodule)    ┌──────────────────────────────┐        │
│       │         │  1. Run OAL engine (Javassist)│        │
│       │         │     → 620 metrics classes     │        │
│       │         │     → 620 builder classes     │        │
│       │         │     → 45 dispatcher classes   │        │
│       │         │                               │        │
│       │         │  2. Run MAL engine (Groovy)   │        │
│       │         │     → 1250 Groovy scripts     │        │
│       │         │     → 1209 meter classes      │        │
│       │         │                               │        │
│       │         │  3. Classpath scan             │        │
│       │         │     → 7 annotation manifests  │        │
│       │         │                               │        │
│       │         │  4. Write manifests            │        │
│       │         └──────────┬───────────────────┘        │
│                            │                             │
│                            ▼                             │
│                   precompiler-generated.jar              │
│                   (all .class files + manifests)         │
└─────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                    RUNTIME                               │
│                                                         │
│  oap-graalvm-server                                     │
│  ┌─────────────────────────────────────────────┐        │
│  │  Same-FQCN replacement classes:             │        │
│  │                                              │        │
│  │  OALEngineLoaderService                      │        │
│  │    → reads oal-metrics-classes.txt manifest   │        │
│  │    → Class.forName() + register              │        │
│  │                                              │        │
│  │  DSL.java (MAL)                              │        │
│  │    → reads mal-groovy-manifest.txt           │        │
│  │    → Class.forName() pre-compiled scripts    │        │
│  │                                              │        │
│  │  MeterSystem.java                            │        │
│  │    → reads MeterFunction.txt manifest        │        │
│  │    → reads mal-meter-classes.txt manifest    │        │
│  │    → no Javassist, no ClassPath.from()       │        │
│  │                                              │        │
│  │  AnnotationScan.java                         │        │
│  │    → reads annotation-scan/*.txt manifests   │        │
│  │    → no Guava ClassPath.from()               │        │
│  └─────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

The **same-FQCN replacement** technique makes this transparent: classes in `oap-graalvm-server` share the exact fully-qualified name with their upstream counterparts. Maven classpath ordering ensures the replacement is loaded. No forking, no patching, no SPI trickery.

## Current Status

### Phase 1: Build System Setup — COMPLETE
- Maven + Makefile build orchestration
- SkyWalking as git submodule (`skywalking/`)
- Fixed module manager (no SPI discovery)
- Simplified `application.yml` for selected providers

### Phase 2: Build-Time Pre-Compilation — COMPLETE
- **OAL immigration**: 9 OAL defines → ~1,285 Javassist classes exported, 6 annotation manifests
- **MAL immigration**: 71 MAL YAML files → 1,250 Groovy scripts + 1,209 Javassist meter classes exported
- **Classpath scanning eliminated**: All 7 Guava `ClassPath.from()` sites replaced with build-time manifests
- **Verification**: 1,281 comparison tests validate pre-compiled classes match fresh Groovy compilation

### Phase 3: Native Image Build — NOT STARTED
- `native-image-maven-plugin` configuration
- GraalVM reflection/resource/JNI metadata (`reflect-config.json`, `resource-config.json`)
- gRPC/Netty/Protobuf native image configuration
- Dynamic Groovy MOP compatibility (biggest unknown risk)
- Get OAP server booting as native image with BanyanDB storage

### Phase 4: Harden & Test — NOT STARTED
- Verify all receiver plugins, query APIs, cluster mode, alarm
- Performance benchmarking vs JVM
- CI: automated native-image build + smoke tests

## Module Selection

This distro targets a **full-feature OAP server** with fixed module/provider selection:

- **Storage**: BanyanDB
- **Cluster**: Kubernetes
- **Configuration**: Kubernetes
- **Receivers**: All (trace, meter, log, profile, browser, OTel, mesh, envoy, Zipkin, Zabbix, Telegraf, etc.)
- **Query**: GraphQL, PromQL, LogQL, Zipkin
- **Alarm, Telemetry, Exporter**: Enabled

## Build

Requires GraalVM JDK 25.

```bash
# Initialize submodule
git submodule update --init --recursive

# Full build (precompiler + tests + server)
JAVA_HOME=/path/to/graalvm-jdk-25 make build-distro
```

## Project Structure

```
skywalking-graalvm-distro/
├── skywalking/                    # Git submodule — DO NOT MODIFY
├── build-tools/
│   ├── precompiler/               # Build-time OAL + MAL + LAL pre-compilation
│   └── config-generator/          # (planned) Build-time config code generation
├── oap-graalvm-server/
│   └── src/
│       ├── main/java/             # Same-FQCN replacement classes
│       │   ├── .../oal/rt/        # OALEngineLoaderService
│       │   ├── .../annotation/    # AnnotationScan
│       │   ├── .../source/        # SourceReceiverImpl
│       │   ├── .../meter/         # MeterSystem, DSL, FilterExpression
│       │   └── .../log/           # LAL DSL
│       └── test/java/             # 1,281 comparison tests
├── PLAN.md                        # Detailed build plan with phase tracking
├── OAL-IMMIGRATION.md             # OAL pre-compilation design doc
└── MAL-IMMIGRATION.md             # MAL pre-compilation design doc
```

## Known Risks

| Risk | Severity | Mitigation |
|---|---|---|
| Dynamic Groovy MOP in native image | High | `ExpandoMetaClass` + `propertyMissing()` may not work. Fallback: upstream DSL changes to eliminate dynamic dispatch. |
| gRPC / Netty native image | Medium | GraalVM reachability metadata repo, Netty substitutions |
| Reflection sites beyond config | Medium | Tracing agent + `reflect-config.json` |
| Kubernetes client in native image | Low | Has documented GraalVM support |

## Release Policy
This repository is experimental. No releases are planned until a working native image is achieved.

## License
Apache 2.0
